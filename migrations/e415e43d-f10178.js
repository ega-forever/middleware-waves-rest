
module.exports.id = 'e415e43d.f10178';

const _ = require('lodash'),
  config = require('../config');

/**
 * @description flow e415e43d.f10178 update
 * @param done
 */
   

module.exports.up = function (done) {
  let coll = this.db.collection(`${_.get(config, 'nodered.mongo.collectionPrefix', '')}noderedstorages`);
  coll.update({"path":"e415e43d.f10178","type":"flows"}, {
    $set: {"path":"e415e43d.f10178","body":[{"id":"6b2f3912.a09f08","type":"http response","z":"e415e43d.f10178","name":"","statusCode":"","x":910,"y":400,"wires":[]},{"id":"12413869.ddc528","type":"http in","z":"e415e43d.f10178","name":"tx","url":"/tx/:hash","method":"get","upload":false,"swaggerDoc":"","x":290,"y":400,"wires":[["92a80432.496758"]]},{"id":"b68ffffb.8e49e","type":"catch","z":"e415e43d.f10178","name":"","scope":null,"x":307,"y":585,"wires":[["49075d44.432d44","cf9070d6.5ab8d"]]},{"id":"5c2fd91f.e496a8","type":"http response","z":"e415e43d.f10178","name":"","statusCode":"","x":764,"y":586,"wires":[]},{"id":"49075d44.432d44","type":"function","z":"e415e43d.f10178","name":"transform","func":"\nlet factories = global.get(\"factories\"); \n\nmsg.payload = factories.messages.generic.fail;\n    \nreturn msg;","outputs":1,"noerr":0,"x":548,"y":585,"wires":[["5c2fd91f.e496a8"]]},{"id":"cf9070d6.5ab8d","type":"debug","z":"e415e43d.f10178","name":"","active":true,"console":"false","complete":"error","x":451,"y":539,"wires":[]},{"id":"cb93a20a.bb5d3","type":"http in","z":"e415e43d.f10178","name":"history","url":"/tx/:addr/history","method":"get","upload":false,"swaggerDoc":"","x":290,"y":240,"wires":[["e558bff.7e2784"]]},{"id":"e558bff.7e2784","type":"function","z":"e415e43d.f10178","name":"parse","func":"const prefix = global.get('settings.mongo.collectionPrefix');\nconst _ = global.get('_');\n\nmsg.address = msg.req.params.addr;\n\nmsg.payload ={ \n    model: `${prefix}TX`, \n    request: {\n      $or: [\n        {sender: msg.address},\n        {recipient: msg.address},\n        {'order1.sender': msg.address},\n        {'order2.sender': msg.address},\n        {'transfers.recipient': msg.address},\n        {'lease.sender': msg.address},\n        {'lease.recipient': msg.address}\n      ]\n  },\n  options: {\n      sort: {timestamp: -1},\n      limit: parseInt(msg.req.query.limit) || 100,\n      skip: parseInt(msg.req.query.skip) || 0\n  }\n};\n\nreturn msg;","outputs":1,"noerr":0,"x":450,"y":240,"wires":[["45ab2beb.917bc4"]]},{"id":"45ab2beb.917bc4","type":"mongo","z":"e415e43d.f10178","model":"","request":"{}","options":"{}","name":"mongo","mode":"1","requestType":"0","dbAlias":"primary.data","x":590,"y":240,"wires":[["452c6d9e.f16384"]]},{"id":"ab0df8ed.00d388","type":"http response","z":"e415e43d.f10178","name":"","statusCode":"","x":910,"y":240,"wires":[]},{"id":"92a80432.496758","type":"async-function","z":"e415e43d.f10178","name":"requestTx","func":"const prefix = global.get('settings.mongo.collectionPrefix');\nconst _ = global.get('_');\n\nmsg.payload ={ \n    model: `${prefix}TX`, \n    request: {\n      _id: msg.req.params.hash\n  }\n};\n\nreturn msg;\n","outputs":1,"noerr":0,"x":460,"y":400,"wires":[["9352032c.01b68"]]},{"id":"9352032c.01b68","type":"mongo","z":"e415e43d.f10178","model":"","request":"{}","options":"{}","name":"mongo","mode":"1","requestType":"0","dbAlias":"primary.data","x":630,"y":400,"wires":[["e2a724dd.f42068"]]},{"id":"452c6d9e.f16384","type":"function","z":"e415e43d.f10178","name":"","func":"msg.payload = msg.payload.map(tx =>{\n  tx.signature = tx._id;\n  delete tx._id;\n  delete tx.__v;\n  return tx;    \n});\n\nreturn msg;","outputs":1,"noerr":0,"x":750,"y":240,"wires":[["ab0df8ed.00d388"]]},{"id":"e2a724dd.f42068","type":"function","z":"e415e43d.f10178","name":"","func":"\nif(!msg.payload[0]){\n    msg.payload = null;\n    return msg;\n}\n\nlet tx = msg.payload[0];\ntx.signature = tx._id;\ndelete tx._id;\ndelete tx.__v;\n\nmsg.payload = tx;\n\nreturn msg;","outputs":1,"noerr":0,"x":770,"y":400,"wires":[["6b2f3912.a09f08"]]},{"id":"b6fd6057.701b3","type":"http in","z":"e415e43d.f10178","name":"send tx","url":"/tx/send","method":"post","upload":false,"swaggerDoc":"","x":290,"y":320,"wires":[["1ffd48b0.295f37"]]},{"id":"a16c085c.68b818","type":"http response","z":"e415e43d.f10178","name":"","statusCode":"","x":630,"y":320,"wires":[]},{"id":"1ffd48b0.295f37","type":"async-function","z":"e415e43d.f10178","name":"requestTx","func":"const rpc = global.get('settings.node.rpc');\nconst requests = global.get('settings.requests');\n\n\nconst MINIMUM_FEE = 100000;\n\nfunction removeRecipientPrefix (original) {\n  if (original.slice(0, 8) === 'address:') \n    return original.slice(8);\n  else \n    return original;\n}\n\nconst prepareTransaction = (tx) => {\n  return {\n    transactionType: null,//'transfer',\n    senderPublicKey: tx.senderPublicKey,\n    assetId: tx.assetId === 'WAVES' ? null : tx.assetId,\n    feeAsset: tx.feeAssetId === 'WAVES' ? null : tx.feeAssetId,\n    timestamp: tx.timestamp,\n    amount: tx.amount,\n    fee: tx.fee || MINIMUM_FEE,\n    recipient: removeRecipientPrefix(tx.recipient),\n    attachment: tx.attachment,\n    signature: tx.signature\n  };\n};\n\nconst tx = prepareTransaction(msg.payload);\n\n\nmsg.payload = await requests.sendTransactionFromLib(tx, rpc).catch(e => { \n    const message = e.error.message || e; return {message: JSON.stringify(message)}; \n});\n\nreturn msg;","outputs":1,"noerr":1,"x":460,"y":320,"wires":[["a16c085c.68b818"]]}]}
  }, {upsert: true}, done);
};

module.exports.down = function (done) {
  let coll = this.db.collection(`${_.get(config, 'nodered.mongo.collectionPrefix', '')}noderedstorages`);
  coll.remove({"path":"e415e43d.f10178","type":"flows"}, done);
};
